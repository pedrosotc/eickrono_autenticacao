<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1800 1100" width="1800" height="1100">
  <defs>
    <style>
      text { font-family: 'Helvetica', 'Arial', sans-serif; fill: #1A365D; }
      .cluster { fill: #F8FAFC; stroke: #2B6CB0; stroke-width: 2; rx: 16; ry: 16; }
      .cluster-title { font-size: 20px; font-weight: 600; }
      .cluster-title-small { font-size: 18px; font-weight: 600; }
      .box { fill: #EBF8FF; stroke: #3182CE; stroke-width: 1.6; rx: 14; ry: 14; }
      .box-alt { fill: #EDF2FF; stroke: #5A67D8; stroke-width: 1.6; rx: 14; ry: 14; }
      .box-green { fill: #F0FFF4; stroke: #38A169; stroke-width: 1.6; rx: 14; ry: 14; }
      .box-yellow { fill: #FFFFF0; stroke: #D69E2E; stroke-width: 1.6; rx: 14; ry: 14; }
      .box-red { fill: #FFF5F5; stroke: #E53E3E; stroke-width: 1.6; rx: 14; ry: 14; }
      .box-purple { fill: #FAF5FF; stroke: #805AD5; stroke-width: 1.6; rx: 14; ry: 14; }
      .box-note { fill: #FFFFF0; stroke: #D69E2E; stroke-width: 1.4; rx: 10; ry: 10; }
      .box-dotted { fill: #F7FAFC; stroke: #4A5568; stroke-width: 1.4; stroke-dasharray: 6 4; rx: 12; ry: 12; }
      .subtitle { font-size: 15px; font-weight: 600; }
      .body { font-size: 14px; }
      .body-small { font-size: 13px; }
      .legend { font-size: 14px; }
      .edge { stroke: #2C5282; stroke-width: 2; fill: none; }
      .edge-dashed { stroke: #2C5282; stroke-width: 2; fill: none; stroke-dasharray: 8 6; }
      .edge-dotted { stroke: #2C5282; stroke-width: 2; fill: none; stroke-dasharray: 4 6; }
    </style>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#2C5282" />
    </marker>
  </defs>

  <rect x="0" y="0" width="1800" height="1100" fill="#FFFFFF" />

  <!-- Clientes -->
  <g id="clientes">
    <rect class="cluster" x="40" y="80" width="320" height="400" />
    <text class="cluster-title" x="60" y="120">Clientes e consumidores</text>

    <rect class="box" x="60" y="140" width="280" height="70" />
    <text class="subtitle" x="80" y="165">App Flutter</text>
    <text class="body" x="80" y="185">Público • Authorization Code + PKCE</text>
    <text class="body" x="80" y="205">DPoP planejado</text>

    <rect class="box" x="60" y="220" width="280" height="70" />
    <text class="subtitle" x="80" y="245">BFF Web Eickrono</text>
    <text class="body" x="80" y="265">Cliente confidencial • PAR + JAR + mTLS</text>

    <rect class="box" x="60" y="300" width="280" height="70" />
    <text class="subtitle" x="80" y="325">APIs internas</text>
    <text class="body" x="80" y="345">Jobs/batch • integrações parceiros</text>

    <rect class="box" x="60" y="380" width="280" height="70" />
    <text class="subtitle" x="80" y="405">Portal suporte / operadores</text>
    <text class="body" x="80" y="425">Fluxo UMA • RBAC Keycloak</text>
  </g>

  <!-- Edge -->
  <g id="edge-layer">
    <rect class="cluster" x="390" y="190" width="230" height="150" />
    <text class="cluster-title" x="410" y="225">Borda de segurança</text>

    <rect class="box" x="410" y="240" width="190" height="90" />
    <text class="subtitle" x="430" y="265">Cloudflare</text>
    <text class="body-small" x="430" y="285">WAF • Rate Limit • Bot Management</text>
    <text class="body-small" x="430" y="305">mTLS Origin Pull • Proteção JARM/nonce</text>
  </g>

  <!-- AWS cluster -->
  <g id="aws">
    <rect class="cluster" x="650" y="60" width="1080" height="900" />
    <text class="cluster-title" x="670" y="100">AWS – Conta Produção</text>

    <rect class="box" x="720" y="130" width="260" height="90" />
    <text class="subtitle" x="740" y="160">ALB / NLB</text>
    <text class="body-small" x="740" y="180">Terminação TLS 1.3 + mTLS</text>
    <text class="body-small" x="740" y="200">Regras por path (/auth, /identidade, /contas)</text>

    <g id="vpc">
      <rect class="cluster" x="700" y="230" width="1000" height="700" />
      <text class="cluster-title-small" x="720" y="265">VPC privativa</text>

      <g id="eks">
        <rect class="cluster" x="730" y="270" width="620" height="480" />
        <text class="cluster-title-small" x="750" y="305">EKS/ECS – Cluster de aplicações</text>

        <rect class="box-alt" x="760" y="320" width="260" height="130" />
        <text class="subtitle" x="780" y="350">Servidor de autorização</text>
        <text class="body-small" x="780" y="370">Keycloak / RH-SSO • temas • SPI</text>
        <text class="body-small" x="780" y="390">FAPI Advanced: PAR/JAR/JARM</text>
        <text class="body-small" x="780" y="410">Rotação JWK • MFA • WebAuthn</text>

        <rect class="box-alt" x="760" y="470" width="260" height="130" />
        <text class="subtitle" x="780" y="500">API Identidade</text>
        <text class="body-small" x="780" y="520">Spring Boot 3 • Java 21</text>
        <text class="body-small" x="780" y="540">Valida aud/nonce • JWKS cache (Caffeine)</text>
        <text class="body-small" x="780" y="560">Escopos identidade/vínculos • Actuator/OTLP</text>

        <rect class="box-alt" x="1040" y="320" width="260" height="130" />
        <text class="subtitle" x="1060" y="350">API Contas</text>
        <text class="body-small" x="1060" y="370">Spring Boot 3 • Java 21</text>
        <text class="body-small" x="1060" y="390">Escopos contas/transações • auditoria</text>
        <text class="body-small" x="1060" y="410">mTLS obrigatório clientes confidenciais</text>

        <rect class="box-alt" x="1040" y="470" width="260" height="130" />
        <text class="subtitle" x="1060" y="500">Agentes sidecar OTEL</text>
        <text class="body-small" x="1060" y="520">OpenTelemetry Collector</text>
        <text class="body-small" x="1060" y="540">Export OTLP → Observabilidade</text>

        <rect class="box-dotted" x="790" y="620" width="500" height="100" />
        <text class="subtitle" x="810" y="650">Caffeine (in-memory)</text>
        <text class="body-small" x="810" y="670">Cache embutido em cada pod • JWKS • configs FAPI</text>
      </g>

      <rect class="box" x="1370" y="300" width="300" height="110" />
      <text class="subtitle" x="1390" y="330">Secrets Manager</text>
      <text class="body-small" x="1390" y="350">Segredos por ambiente • credenciais BD</text>
      <text class="body-small" x="1390" y="370">Certificados mTLS • rotacionados via KMS</text>

      <rect class="box" x="1370" y="430" width="300" height="90" />
      <text class="subtitle" x="1390" y="460">Systems Manager Parameter Store</text>
      <text class="body-small" x="1390" y="480">Config compartilhada • feature flags</text>

      <rect class="box" x="1370" y="530" width="300" height="90" />
      <text class="subtitle" x="1390" y="560">AWS KMS / HSM</text>
      <text class="body-small" x="1390" y="580">CMKs • assinatura JWK • criptografia TLS</text>

      <rect class="box-red" x="1370" y="640" width="300" height="160" />
      <text class="subtitle" x="1390" y="670">Stack Observabilidade</text>
      <text class="body-small" x="1390" y="690">Prometheus • Amazon Managed Grafana</text>
      <text class="body-small" x="1390" y="710">CloudWatch Logs • SIEM • Alertas SNS/PagerDuty</text>

      <g id="dados">
        <rect class="cluster" x="760" y="760" width="560" height="180" />
        <text class="cluster-title-small" x="780" y="795">Camada de dados</text>

        <rect class="box-green" x="780" y="800" width="320" height="120" />
        <text class="subtitle" x="800" y="830">Amazon RDS PostgreSQL</text>
        <text class="body-small" x="800" y="850">Schemas: keycloak, identidade, contas</text>
        <text class="body-small" x="800" y="870">Replicação Multi-AZ • auditoria • Flyway</text>

        <rect class="box-green" x="1120" y="800" width="180" height="120" />
        <text class="subtitle" x="1140" y="830">Backups &amp; DR</text>
        <text class="body-small" x="1140" y="850">Snapshots automáticos</text>
        <text class="body-small" x="1140" y="870">Export S3 • testes restauração</text>
      </g>
    </g>
  </g>

  <!-- Autoridade certificadora -->
  <rect class="box-purple" x="410" y="380" width="240" height="120" />
  <text class="subtitle" x="430" y="410">Autoridade certificadora interna</text>
  <text class="body-small" x="430" y="430">ACM + scripts autoassinados dev/hml</text>
  <text class="body-small" x="430" y="450">Distribuição certificados mTLS</text>

  <!-- Legenda -->
  <rect class="box-note" x="1180" y="980" width="520" height="90" />
  <text class="subtitle" x="1200" y="1010">Notas rápidas</text>
  <text class="legend" x="1200" y="1030">• Fluxo público: Authorization Code + PKCE (Flutter)</text>
  <text class="legend" x="1200" y="1050">• Clientes confidenciais: PAR + JAR + JARM + mTLS</text>
  <text class="legend" x="1200" y="1070">• Anti-replay: nonce, jti store, PKCE • Tolerância clock skew 1 min</text>

  <!-- Fluxos -->
  <g id="fluxos">
    <!-- Clientes → Cloudflare -->
    <path class="edge" marker-end="url(#arrow)" d="M 340 175 H 410" />
    <text class="body" x="375" y="165" text-anchor="middle">HTTPS + PKCE</text>

    <path class="edge" marker-end="url(#arrow)" d="M 340 255 H 410" />
    <text class="body" x="375" y="245" text-anchor="middle">HTTPS + mTLS</text>

    <path class="edge" marker-end="url(#arrow)" d="M 340 335 H 410" />
    <text class="body" x="375" y="325" text-anchor="middle">HTTPS + mTLS</text>

    <path class="edge" marker-end="url(#arrow)" d="M 340 415 H 410" />
    <text class="body" x="375" y="405" text-anchor="middle">HTTPS + RBAC</text>

    <!-- Cloudflare → ALB/NLB -->
    <path class="edge" marker-end="url(#arrow)" d="M 600 285 H 700 V 175 H 720" />
    <text class="body" x="655" y="265" text-anchor="middle">mTLS Origin Pull</text>

    <!-- ALB → serviços -->
    <path class="edge" marker-end="url(#arrow)" d="M 850 220 V 320" />
    <text class="body" x="860" y="260">/auth</text>

    <path class="edge" marker-end="url(#arrow)" d="M 850 220 V 270 H 890 V 470" />
    <text class="body" x="865" y="330">/identidade</text>

    <path class="edge" marker-end="url(#arrow)" d="M 850 220 V 270 H 1170 V 320" />
    <text class="body" x="990" y="240">/contas</text>

    <!-- Telemetria -->
    <path class="edge-dashed" marker-end="url(#arrow)" d="M 1020 385 H 1040" />
    <text class="body-small" x="1030" y="375" text-anchor="middle">OTLP</text>

    <path class="edge-dashed" marker-end="url(#arrow)" d="M 1020 535 H 1040" />
    <text class="body-small" x="1030" y="525" text-anchor="middle">OTLP</text>

    <path class="edge-dashed" marker-end="url(#arrow)" d="M 1170 450 V 470" />
    <text class="body-small" x="1180" y="460">OTLP</text>

    <path class="edge" marker-end="url(#arrow)" d="M 1300 535 H 1370 V 720" />
    <text class="body-small" x="1335" y="620" text-anchor="middle">Métricas + traces</text>

    <!-- Banco de dados -->
    <path class="edge" marker-end="url(#arrow)" d="M 890 450 H 860 V 760 H 820 V 800" />
    <text class="body-small" x="845" y="735">JDBC schema keycloak</text>

    <path class="edge" marker-end="url(#arrow)" d="M 890 600 H 920 V 780 H 900 V 800" />
    <text class="body-small" x="905" y="755">JDBC schema identidade</text>

    <path class="edge" marker-end="url(#arrow)" d="M 1170 450 H 1190 V 780 H 1000 V 800" />
    <text class="body-small" x="1070" y="735">JDBC schema contas</text>

    <path class="edge" marker-end="url(#arrow)" d="M 1100 860 H 1120" />
    <text class="body-small" x="1110" y="845">Snapshots / PITR</text>

    <!-- Segredos e configuração -->
    <path class="edge" marker-end="url(#arrow)" d="M 1370 330 V 360 H 1020" />
    <text class="body-small" x="1210" y="345" text-anchor="middle">Segredos (credenciais, mTLS)</text>

    <path class="edge" marker-end="url(#arrow)" d="M 1370 355 V 535 H 1020" />
    <text class="body-small" x="1230" y="460" text-anchor="middle">Segredos (APIs)</text>

    <path class="edge" marker-end="url(#arrow)" d="M 1370 380 H 1300" />
    <text class="body-small" x="1340" y="370">Segredos (chaves JWK)</text>

    <path class="edge" marker-end="url(#arrow)" d="M 1370 430 H 1030 V 410 H 1020" />
    <text class="body-small" x="1210" y="415" text-anchor="middle">Config (Keycloak)</text>

    <path class="edge" marker-end="url(#arrow)" d="M 1370 455 H 1020" />
    <text class="body-small" x="1200" y="445" text-anchor="middle">Config (API Identidade)</text>

    <path class="edge" marker-end="url(#arrow)" d="M 1370 480 H 1300" />
    <text class="body-small" x="1340" y="470">Config (API Contas)</text>

    <!-- KMS -->
    <path class="edge" marker-end="url(#arrow)" d="M 1520 530 V 360" />
    <text class="body-small" x="1530" y="450">KMS → Secrets</text>

    <path class="edge" marker-end="url(#arrow)" d="M 1520 530 V 150 H 850" />
    <text class="body-small" x="1390" y="165">KMS → Certificados TLS</text>

    <!-- Autoridade certificadora -->
    <path class="edge" marker-end="url(#arrow)" d="M 650 440 V 285 H 600" />
    <text class="body-small" x="625" y="330" text-anchor="middle">Certificados mTLS</text>

    <path class="edge" marker-end="url(#arrow)" d="M 650 410 V 200 H 720" />
    <text class="body-small" x="685" y="260" text-anchor="middle">Certificados origin</text>

    <!-- Integrações internas -->
    <path class="edge-dashed" marker-end="url(#arrow)" d="M 880 450 V 470" />
    <text class="body-small" x="885" y="463">JWKS / introspecção</text>

    <path class="edge-dashed" marker-end="url(#arrow)" d="M 1020 420 H 1060 V 320" />
    <text class="body-small" x="1050" y="365">JWKS / introspecção</text>

    <!-- Cache local -->
    <path class="edge-dotted" marker-end="url(#arrow)" d="M 890 600 V 620" />
    <text class="body-small" x="880" y="612">Cache local</text>

    <path class="edge-dotted" marker-end="url(#arrow)" d="M 1170 450 H 1150 V 620" />
    <text class="body-small" x="1145" y="530">Cache local</text>
  </g>

</svg>
